name: Build and Release Feeder ESP Firmware

# Trigger ONLY on version tags: v1.0.0, v1.2.3, etc.
# To deploy a new OTA update: git tag v1.x.x && git push origin v1.x.x
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    name: Build firmware
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache PlatformIO packages
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: pio-${{ runner.os }}-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            pio-${{ runner.os }}-

      - name: Install PlatformIO
        run: pip install platformio

      - name: Write firmware version into Version.h
        run: |
          echo "#pragma once" > src/config/Version.h
          echo "// Auto-generated by GitHub Actions â€” do not edit manually" >> src/config/Version.h
          echo "#define FIRMWARE_VERSION \"${{ github.ref_name }}\"" >> src/config/Version.h
          echo "Version.h written: ${{ github.ref_name }}"

      - name: Build production firmware (esp32prod)
        run: pio run -e esp32prod

      - name: Rename firmware binary
        run: cp .pio/build/esp32prod/firmware.bin feeder-firmware.bin

      - name: Create GitHub Release with firmware asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Feeder ESP ${{ github.ref_name }}"
          body: |
            ## Feeder ESP Firmware ${{ github.ref_name }}

            **OTA Update**: The WiFi ESP will automatically detect this release, download the firmware, and forward it to the Feeder ESP over Serial2.
          files: feeder-firmware.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
